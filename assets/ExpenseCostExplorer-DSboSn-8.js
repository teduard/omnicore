import{r as u,_ as L,l,j as t,H as B,S,h as H,B as $,L as k,g as F,R as A,A as R,E as j,f as T,c as M,ac as _,ae as z}from"./index-C3RXUv3R.js";import{T as N}from"./index-sbGZmitb.js";import{M as P}from"./MonthPicker-zNYVq-wH.js";import{B as U}from"./index-wsLrhGX8.js";import{E as Y}from"./ExpenseLayout-EktDzCz8.js";import"./internal-DXmJE_9T.js";function G(a){const g=u.useContext(L),{defaultCurrency:x}=g,[r,m]=u.useState([]);u.useEffect(()=>{l.debug("props.LoadingStatus= ",a.LoadingStatus)},[a.LoadingStatus]);const h=e=>{switch(console.info(e),e.detail.id){case"edit":l.debug("edit expense: ",r);break;case"delete":l.debug("delete expense: ",r);break}};return t.jsx(N,{loading:a.LoadingStatus==="loading",loadingText:"Loading expenses",renderAriaLive:({firstIndex:e,lastIndex:y,totalItemsCount:f})=>`Displaying items ${e} to ${y} of ${f}`,columnDisplay:[{id:"expenseId",visible:!1},{id:"entryDate",visible:!0},{id:"amount",visible:!0},{id:"category",visible:!0},{id:"comment",visible:!0},{id:"avoidable",visible:!0}],columnDefinitions:[{id:"expenseId",header:"expenseId",cell:e=>e.expenseId,sortingField:"name",isRowHeader:!0},{id:"entryDate",header:"Entry Date",cell:e=>t.jsx(k,{href:"/expense/edit/"+e.expenseId,children:e.entryDate||"-"}),sortingField:"name",isRowHeader:!0},{id:"amount",header:"Amount",cell:e=>`${e.amount} ${x.value}`||"-",sortingField:"alt"},{id:"category",header:"Category",cell:e=>e.category||"-"},{id:"comment",header:"Comment",cell:e=>e.comment||"-"},{id:"avoidable",header:"Avoidable",cell:e=>e.couldHaveBeenAvoided?t.jsx(F,{name:"status-warning"}):""}],selectedItems:r,onSelectionChange:({detail:e})=>m(e.selectedItems),enableKeyboardNavigation:!0,items:a.expenseData,sortingDisabled:!0,selectionType:"single",trackBy:"expenseId",stripedRows:!0,stickyHeader:!0,empty:t.jsx(H,{margin:{vertical:"xs"},textAlign:"center",color:"inherit",children:t.jsxs(S,{size:"m",children:[t.jsx("b",{children:"No expense items"}),t.jsx($,{children:"Add expense"})]})}),header:t.jsx(B,{actions:t.jsxs(S,{direction:"horizontal",size:"xs",children:[t.jsx(U,{onItemClick:h,items:[{text:"Edit",id:"edit",disabled:!1},{text:"Delete",id:"delete",disabled:!1}],children:"Actions"}),t.jsx(P,{onRefresh:function(){l.debug("mnth picker"),a.onMonthChange()}})]}),children:"Your Expenses"})})}const D={expenseAggregate:new Array,expenseTotal:0,LoadingStatus:"not-started"};function K({updateCategoryAggregate:a}){const g=u.useContext(T);if(!g)throw new Error("useAuth must be used within AuthProvider");const{user:x}=g,{execute:r,isReady:m}=M(),{selectedDate:h}=_(),e={ExpenseItemsCount:0,CouldHaveBeenAvoidedCount:0,LoadingStatus:"not-started"},[y,f]=A.useState(e),[d,I]=A.useState(new Array),[w,v]=A.useState(new Array),C=()=>{l.debug("refresh data in updateExpenseHandler"),f({...e,LoadingStatus:"loading"}),a({...D,LoadingStatus:"loading"}),v([]);const p=h.split("-"),E=parseInt(p[0]),b=parseInt(p[1]),i=new Date(E,b,0),n=`${i.getFullYear()}-${i.getMonth()<9?"0"+(i.getMonth()+1):i.getMonth()+1}-${i.getDate()}}`,s=r(`
      select e.*,c.name, c.category_id from Expenses e
join Categories c
on e.category_id = c.category_id
where e.user_id = ${x.UserId}
and e.created_date >= '${h}-01' and e.created_date <= '${n}'
      `),c=new Array;!s||s.length===0?(l.debug("no expenses on local"),I([])):(s[0].values.map(o=>{c.push({expenseId:o[0],entryDate:o[6],amount:o[3],category:{name:o[8],categoryId:o[9]},comment:o[4],couldHaveBeenAvoided:o[5]})}),I(c))};return u.useEffect(()=>{const p=new Array;d.forEach(n=>{const s={expenseId:n.expenseId,entryDate:n.entryDate,amount:n.amount,category:n.category.name,comment:n.comment,couldHaveBeenAvoided:n.couldHaveBeenAvoided};p.push(s)}),v(p),f({ExpenseItemsCount:d.length,CouldHaveBeenAvoidedCount:d.filter(n=>n.couldHaveBeenAvoided===!0).length,LoadingStatus:"success"});const E=d.reduce((n,s)=>n+s.amount,0).toFixed(2),b=new Array;d.reduce((n,s)=>n.add(s.category.name),new Set).forEach(n=>{const s={categoryName:n,categoryAmount:0};s.categoryAmount=parseFloat(d.filter(c=>c.category.name===n).reduce((c,o)=>c+o.amount,0).toFixed(2)),b.push(s)}),a({...D,expenseAggregate:b,expenseTotal:E||0,LoadingStatus:"success"})},[d]),u.useEffect(()=>{m&&C()},[m]),t.jsx(t.Fragment,{children:t.jsxs(z,{gridDefinition:[{colspan:{default:12}}],children:[!1,t.jsx(G,{expenseData:w,LoadingStatus:y.LoadingStatus,onMonthChange:C})]})})}function q(){return t.jsx(R,{items:[{text:"Dashboard",href:j.path},{text:"All expenses",href:`${j.path}/cost`}]})}function ee(){const a=r=>{x(r)},[g,x]=A.useState(D);return t.jsx(t.Fragment,{children:t.jsx(Y,{content:t.jsx(K,{updateCategoryAggregate:a}),breadcrumbs:t.jsx(q,{})})})}export{ee as default};
